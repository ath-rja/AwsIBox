{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Conditions": {
        "CloudFrontWebACLId": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "CloudFrontWebACLIdOverride"
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        {
                                            "Ref": "CloudFrontWebACLId"
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "CloudFrontWebACLIdOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        "None",
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "CloudFrontWebACLIdOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CloudFrontWebACLId"
                        },
                        ""
                    ]
                }
            ]
        },
        "ClusterStackOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ClusterStack"
                        },
                        ""
                    ]
                }
            ]
        },
        "ContainerDefinitions1CpuOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ContainerDefinitions1Cpu"
                        },
                        ""
                    ]
                }
            ]
        },
        "ContainerDefinitions1MemoryOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ContainerDefinitions1Memory"
                        },
                        ""
                    ]
                }
            ]
        },
        "ContainerDefinitions1MemoryReservationOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ContainerDefinitions1MemoryReservation"
                        },
                        ""
                    ]
                }
            ]
        },
        "CpuOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "Cpu"
                        },
                        ""
                    ]
                }
            ]
        },
        "CpuTask": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "CpuOverride"
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        {
                                            "Ref": "Cpu"
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "CpuOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        "None",
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "DeploymentConfigurationMaximumPercentOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DeploymentConfigurationMaximumPercent"
                        },
                        ""
                    ]
                }
            ]
        },
        "DeploymentConfigurationMinimumHealthyPercentOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DeploymentConfigurationMinimumHealthyPercent"
                        },
                        ""
                    ]
                }
            ]
        },
        "DockerLabelLastUpdateOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DockerLabelLastUpdate"
                        },
                        ""
                    ]
                }
            ]
        },
        "LaunchTypeFarGate": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "LaunchTypeOverride"
                        },
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "LaunchType"
                                },
                                "FARGATE"
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "LaunchTypeOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Equals": [
                                "EC2",
                                "FARGATE"
                            ]
                        }
                    ]
                }
            ]
        },
        "LaunchTypeOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LaunchType"
                        },
                        ""
                    ]
                }
            ]
        },
        "ListenerLoadBalancerHttpPort": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "ListenerLoadBalancerHttpPortOverride"
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        {
                                            "Ref": "ListenerLoadBalancerHttpPort"
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "ListenerLoadBalancerHttpPortOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        80,
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "ListenerLoadBalancerHttpPortOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ListenerLoadBalancerHttpPort"
                        },
                        ""
                    ]
                }
            ]
        },
        "ListenerLoadBalancerHttpsPort": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "ListenerLoadBalancerHttpsPortOverride"
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        {
                                            "Ref": "ListenerLoadBalancerHttpsPort"
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "ListenerLoadBalancerHttpsPortOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        443,
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "ListenerLoadBalancerHttpsPortOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ListenerLoadBalancerHttpsPort"
                        },
                        ""
                    ]
                }
            ]
        },
        "LoadBalancerApplicationStackOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LoadBalancerApplicationStack"
                        },
                        ""
                    ]
                }
            ]
        },
        "LoadBalancerSslCertificateAdHoc": {
            "Fn::And": [
                {
                    "Condition": "ListenerLoadBalancerHttpsPort"
                },
                {
                    "Fn::Equals": [
                        true,
                        "None"
                    ]
                }
            ]
        },
        "LoadBalancerSslCertificateOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LoadBalancerSslCertificate"
                        },
                        ""
                    ]
                }
            ]
        },
        "LogConfiguration": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        "awslogs",
                        "None"
                    ]
                }
            ]
        },
        "LogDriverOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LogDriver"
                        },
                        ""
                    ]
                }
            ]
        },
        "MemoryOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "Memory"
                        },
                        ""
                    ]
                }
            ]
        },
        "NetworkModeAwsVpc": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "NetworkModeOverride"
                        },
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "NetworkMode"
                                },
                                "awsvpc"
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "NetworkModeOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Equals": [
                                "bridge",
                                "awsvpc"
                            ]
                        }
                    ]
                },
                {
                    "Condition": "LaunchTypeFarGate"
                }
            ]
        },
        "NetworkModeOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "NetworkMode"
                        },
                        ""
                    ]
                }
            ]
        },
        "NetworkModeStandard": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "NetworkModeOverride"
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        {
                                            "Ref": "NetworkMode"
                                        },
                                        "awsvpc"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Fn::Not": [
                                {
                                    "Condition": "NetworkModeOverride"
                                }
                            ]
                        },
                        {
                            "Fn::Not": [
                                {
                                    "Fn::Equals": [
                                        "bridge",
                                        "awsvpc"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "SecurityGroup0": {
            "Fn::Not": [
                {
                    "Fn::Or": [
                        {
                            "Fn::And": [
                                {
                                    "Condition": "SecurityGroupsOverride"
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                0,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        {
                                                            "Ref": "SecurityGroups"
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        },
                        {
                            "Fn::And": [
                                {
                                    "Fn::Not": [
                                        {
                                            "Condition": "SecurityGroupsOverride"
                                        }
                                    ]
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                0,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        "BaseInstance,None,None,None"
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "SecurityGroup1": {
            "Fn::Not": [
                {
                    "Fn::Or": [
                        {
                            "Fn::And": [
                                {
                                    "Condition": "SecurityGroupsOverride"
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                1,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        {
                                                            "Ref": "SecurityGroups"
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        },
                        {
                            "Fn::And": [
                                {
                                    "Fn::Not": [
                                        {
                                            "Condition": "SecurityGroupsOverride"
                                        }
                                    ]
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                1,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        "BaseInstance,None,None,None"
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "SecurityGroup2": {
            "Fn::Not": [
                {
                    "Fn::Or": [
                        {
                            "Fn::And": [
                                {
                                    "Condition": "SecurityGroupsOverride"
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                2,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        {
                                                            "Ref": "SecurityGroups"
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        },
                        {
                            "Fn::And": [
                                {
                                    "Fn::Not": [
                                        {
                                            "Condition": "SecurityGroupsOverride"
                                        }
                                    ]
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                2,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        "BaseInstance,None,None,None"
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "SecurityGroup3": {
            "Fn::Not": [
                {
                    "Fn::Or": [
                        {
                            "Fn::And": [
                                {
                                    "Condition": "SecurityGroupsOverride"
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                3,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        {
                                                            "Ref": "SecurityGroups"
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        },
                        {
                            "Fn::And": [
                                {
                                    "Fn::Not": [
                                        {
                                            "Condition": "SecurityGroupsOverride"
                                        }
                                    ]
                                },
                                {
                                    "Fn::Equals": [
                                        {
                                            "Fn::Select": [
                                                3,
                                                {
                                                    "Fn::Split": [
                                                        ",",
                                                        "BaseInstance,None,None,None"
                                                    ]
                                                }
                                            ]
                                        },
                                        "None"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "SecurityGroupsOverride": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "SecurityGroups"
                        },
                        ",,,"
                    ]
                }
            ]
        }
    },
    "Description": "reserve-cpu [ecs]",
    "Mappings": {
        "dev": {
            "eu-central-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 0,
                "AlarmTargetInternal5XXEvaluationPeriods": 0,
                "CapacityDesired": "SkipClass",
                "CapacityMax": 1,
                "CapacityMin": 1,
                "ContainerDefinitions1Cpu": 512,
                "HostedZoneIdLB": "Z215JYRZR1TBD5",
                "ScheduledActionUpMaxSize": "CapacityMax",
                "ScheduledActionUpMinSize": "CapacityMin"
            },
            "eu-west-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 0,
                "AlarmTargetInternal5XXEvaluationPeriods": 0,
                "CapacityDesired": "SkipClass",
                "CapacityMax": 1,
                "CapacityMin": 1,
                "ContainerDefinitions1Cpu": 512,
                "HostedZoneIdLB": "Z32O12XQLNTSW2",
                "ScheduledActionUpMaxSize": "CapacityMax",
                "ScheduledActionUpMinSize": "CapacityMin"
            },
            "us-east-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 0,
                "AlarmTargetInternal5XXEvaluationPeriods": 0,
                "CapacityDesired": "SkipClass",
                "CapacityMax": 1,
                "CapacityMin": 1,
                "ContainerDefinitions1Cpu": 512,
                "HostedZoneIdLB": "Z35SXDOTRQ7X7K",
                "ScheduledActionUpMaxSize": "CapacityMax",
                "ScheduledActionUpMinSize": "CapacityMin"
            }
        },
        "prd": {
            "eu-central-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 2,
                "AlarmTargetInternal5XXEvaluationPeriods": 2,
                "CapacityDesired": 2,
                "CapacityMax": 9,
                "CapacityMin": 2,
                "ContainerDefinitions1Cpu": 256,
                "HostedZoneIdLB": "Z215JYRZR1TBD5",
                "ScheduledActionUpMaxSize": "k",
                "ScheduledActionUpMinSize": "k"
            },
            "eu-west-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 2,
                "AlarmTargetInternal5XXEvaluationPeriods": 2,
                "CapacityDesired": 2,
                "CapacityMax": 9,
                "CapacityMin": 2,
                "ContainerDefinitions1Cpu": 256,
                "HostedZoneIdLB": "Z32O12XQLNTSW2",
                "ScheduledActionUpMaxSize": "k",
                "ScheduledActionUpMinSize": "k"
            },
            "us-east-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 2,
                "AlarmTargetInternal5XXEvaluationPeriods": 2,
                "CapacityDesired": 2,
                "CapacityMax": 9,
                "CapacityMin": 2,
                "ContainerDefinitions1Cpu": 256,
                "HostedZoneIdLB": "Z35SXDOTRQ7X7K",
                "ScheduledActionUpMaxSize": "k",
                "ScheduledActionUpMinSize": "k"
            }
        },
        "stg": {
            "eu-central-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 0,
                "AlarmTargetInternal5XXEvaluationPeriods": 0,
                "CapacityDesired": "SkipClass",
                "CapacityMax": 1,
                "CapacityMin": 1,
                "ContainerDefinitions1Cpu": 512,
                "HostedZoneIdLB": "Z215JYRZR1TBD5",
                "ScheduledActionUpMaxSize": "CapacityMax",
                "ScheduledActionUpMinSize": "CapacityMin"
            },
            "eu-west-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 0,
                "AlarmTargetInternal5XXEvaluationPeriods": 0,
                "CapacityDesired": "SkipClass",
                "CapacityMax": 1,
                "CapacityMin": 1,
                "ContainerDefinitions1Cpu": 512,
                "HostedZoneIdLB": "Z32O12XQLNTSW2",
                "ScheduledActionUpMaxSize": "CapacityMax",
                "ScheduledActionUpMinSize": "CapacityMin"
            },
            "us-east-1": {
                "AlarmTargetExternal5XXEvaluationPeriods": 0,
                "AlarmTargetInternal5XXEvaluationPeriods": 0,
                "CapacityDesired": "SkipClass",
                "CapacityMax": 1,
                "CapacityMin": 1,
                "ContainerDefinitions1Cpu": 512,
                "HostedZoneIdLB": "Z35SXDOTRQ7X7K",
                "ScheduledActionUpMaxSize": "CapacityMax",
                "ScheduledActionUpMinSize": "CapacityMin"
            }
        }
    },
    "Outputs": {
        "BrandDomain": {
            "Value": "numenor.arda"
        },
        "CloudFrontWebACLId": {
            "Value": {
                "Fn::If": [
                    "CloudFrontWebACLIdOverride",
                    {
                        "Ref": "CloudFrontWebACLId"
                    },
                    "None"
                ]
            }
        },
        "ContainerDefinitions1Constraints": {
            "Value": {
                "Fn::Sub": [
                    "Cpu:${Cpu},Memory:${Memory},MemoryReservation:${MemoryReservation}",
                    {
                        "Cpu": {
                            "Fn::If": [
                                "CpuTask",
                                {
                                    "Fn::If": [
                                        "CpuOverride",
                                        {
                                            "Ref": "Cpu"
                                        },
                                        "None"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "ContainerDefinitions1CpuOverride",
                                        {
                                            "Ref": "ContainerDefinitions1Cpu"
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                {
                                                    "Ref": "EnvShort"
                                                },
                                                {
                                                    "Ref": "AWS::Region"
                                                },
                                                "ContainerDefinitions1Cpu"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "Memory": {
                            "Fn::If": [
                                "LaunchTypeFarGate",
                                {
                                    "Fn::If": [
                                        "MemoryOverride",
                                        {
                                            "Ref": "Memory"
                                        },
                                        512
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "ContainerDefinitions1MemoryOverride",
                                        {
                                            "Ref": "ContainerDefinitions1Memory"
                                        },
                                        64
                                    ]
                                }
                            ]
                        },
                        "MemoryReservation": {
                            "Fn::If": [
                                "ContainerDefinitions1MemoryReservationOverride",
                                {
                                    "Ref": "ContainerDefinitions1MemoryReservation"
                                },
                                32
                            ]
                        }
                    }
                ]
            }
        },
        "ContainerDefinitions1Envs": {
            "Value": {
                "Fn::Sub": ""
            }
        },
        "Cpu": {
            "Condition": "CpuTask",
            "Value": {
                "Fn::If": [
                    "CpuOverride",
                    {
                        "Ref": "Cpu"
                    },
                    "None"
                ]
            }
        },
        "Env": {
            "Value": {
                "Ref": "Env"
            }
        },
        "EnvApp1Version": {
            "Value": {
                "Ref": "EnvApp1Version"
            }
        },
        "EnvRole": {
            "Value": {
                "Ref": "EnvRole"
            }
        },
        "EnvStackVersion": {
            "Value": {
                "Ref": "EnvStackVersion"
            }
        },
        "LaunchType": {
            "Value": {
                "Fn::If": [
                    "LaunchTypeOverride",
                    {
                        "Ref": "LaunchType"
                    },
                    "EC2"
                ]
            }
        },
        "LoadBalancerSslCertificate": {
            "Value": {
                "Fn::If": [
                    "LoadBalancerSslCertificateOverride",
                    {
                        "Ref": "LoadBalancerSslCertificate"
                    },
                    true
                ]
            }
        },
        "LogDriver": {
            "Value": {
                "Fn::If": [
                    "LogDriverOverride",
                    {
                        "Ref": "LogDriver"
                    },
                    "awslogs"
                ]
            }
        },
        "Memory": {
            "Condition": "LaunchTypeFarGate",
            "Value": {
                "Fn::If": [
                    "MemoryOverride",
                    {
                        "Ref": "Memory"
                    },
                    512
                ]
            }
        },
        "SecurityGroups": {
            "Condition": "NetworkModeAwsVpc",
            "Value": {
                "Fn::Sub": [
                    "Service=${SecurityGroupEcsService},${SecurityGroupName0}=${SecurityGroupValue0},${SecurityGroupName1}=${SecurityGroupValue1},${SecurityGroupName2}=${SecurityGroupValue2},${SecurityGroupName3}=${SecurityGroupValue3}",
                    {
                        "SecurityGroupEcsService": {
                            "Ref": "SecurityGroupEcsService"
                        },
                        "SecurityGroupName0": {
                            "Fn::Select": [
                                0,
                                {
                                    "Fn::Split": [
                                        ",",
                                        {
                                            "Fn::If": [
                                                "SecurityGroupsOverride",
                                                {
                                                    "Ref": "SecurityGroups"
                                                },
                                                "BaseInstance,None,None,None"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "SecurityGroupName1": {
                            "Fn::Select": [
                                1,
                                {
                                    "Fn::Split": [
                                        ",",
                                        {
                                            "Fn::If": [
                                                "SecurityGroupsOverride",
                                                {
                                                    "Ref": "SecurityGroups"
                                                },
                                                "BaseInstance,None,None,None"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "SecurityGroupName2": {
                            "Fn::Select": [
                                2,
                                {
                                    "Fn::Split": [
                                        ",",
                                        {
                                            "Fn::If": [
                                                "SecurityGroupsOverride",
                                                {
                                                    "Ref": "SecurityGroups"
                                                },
                                                "BaseInstance,None,None,None"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "SecurityGroupName3": {
                            "Fn::Select": [
                                3,
                                {
                                    "Fn::Split": [
                                        ",",
                                        {
                                            "Fn::If": [
                                                "SecurityGroupsOverride",
                                                {
                                                    "Ref": "SecurityGroups"
                                                },
                                                "BaseInstance,None,None,None"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "SecurityGroupValue0": {
                            "Fn::If": [
                                "SecurityGroup0",
                                {
                                    "Fn::ImportValue": {
                                        "Fn::Sub": [
                                            "SecurityGroup${ImportName}",
                                            {
                                                "ImportName": {
                                                    "Fn::Select": [
                                                        0,
                                                        {
                                                            "Fn::Split": [
                                                                ",",
                                                                {
                                                                    "Fn::If": [
                                                                        "SecurityGroupsOverride",
                                                                        {
                                                                            "Ref": "SecurityGroups"
                                                                        },
                                                                        "BaseInstance,None,None,None"
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                },
                                "None"
                            ]
                        },
                        "SecurityGroupValue1": {
                            "Fn::If": [
                                "SecurityGroup1",
                                {
                                    "Fn::ImportValue": {
                                        "Fn::Sub": [
                                            "SecurityGroup${ImportName}",
                                            {
                                                "ImportName": {
                                                    "Fn::Select": [
                                                        1,
                                                        {
                                                            "Fn::Split": [
                                                                ",",
                                                                {
                                                                    "Fn::If": [
                                                                        "SecurityGroupsOverride",
                                                                        {
                                                                            "Ref": "SecurityGroups"
                                                                        },
                                                                        "BaseInstance,None,None,None"
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                },
                                "None"
                            ]
                        },
                        "SecurityGroupValue2": {
                            "Fn::If": [
                                "SecurityGroup2",
                                {
                                    "Fn::ImportValue": {
                                        "Fn::Sub": [
                                            "SecurityGroup${ImportName}",
                                            {
                                                "ImportName": {
                                                    "Fn::Select": [
                                                        2,
                                                        {
                                                            "Fn::Split": [
                                                                ",",
                                                                {
                                                                    "Fn::If": [
                                                                        "SecurityGroupsOverride",
                                                                        {
                                                                            "Ref": "SecurityGroups"
                                                                        },
                                                                        "BaseInstance,None,None,None"
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                },
                                "None"
                            ]
                        },
                        "SecurityGroupValue3": {
                            "Fn::If": [
                                "SecurityGroup3",
                                {
                                    "Fn::ImportValue": {
                                        "Fn::Sub": [
                                            "SecurityGroup${ImportName}",
                                            {
                                                "ImportName": {
                                                    "Fn::Select": [
                                                        3,
                                                        {
                                                            "Fn::Split": [
                                                                ",",
                                                                {
                                                                    "Fn::If": [
                                                                        "SecurityGroupsOverride",
                                                                        {
                                                                            "Ref": "SecurityGroups"
                                                                        },
                                                                        "BaseInstance,None,None,None"
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                },
                                "None"
                            ]
                        }
                    }
                ]
            }
        },
        "StackType": {
            "Value": "ecs"
        }
    },
    "Parameters": {
        "CloudFrontWebACLId": {
            "Default": "",
            "Description": "CloudFront WebACLId - empty for default based on env/role",
            "Type": "String"
        },
        "ClusterStack": {
            "Default": "",
            "Description": "Cluster Stack Name used to launch service on - - empty for default based on env/role",
            "Type": "String"
        },
        "ContainerDefinitions1Cpu": {
            "Default": "",
            "Description": "Cpu Share for containers - empty for default based on env/role",
            "Type": "String"
        },
        "ContainerDefinitions1Memory": {
            "Default": "",
            "Description": "Memory hard limit for containers - empty for default based on env/role",
            "Type": "String"
        },
        "ContainerDefinitions1MemoryReservation": {
            "Default": "",
            "Description": "Memory soft limit for containers - empty for default based on env/role",
            "Type": "String"
        },
        "Cpu": {
            "AllowedValues": [
                "",
                "None",
                "128",
                "256",
                "384",
                "512",
                "640",
                "768",
                "896",
                "1024",
                "1152",
                "1280",
                "1408",
                "1536",
                "1664",
                "1792",
                "1920",
                "2048",
                "2176",
                "2304",
                "2432",
                "2560",
                "2688",
                "2816",
                "2944",
                "3072",
                "3200",
                "3328",
                "3456",
                "3584",
                "3712",
                "3840",
                "3968",
                "4096"
            ],
            "Default": "",
            "Description": "Cpu used by task - empty for default based on env/role",
            "Type": "String"
        },
        "DeploymentConfigurationMaximumPercent": {
            "Default": "",
            "Description": "DeploymentConfiguration MaximumPercent - empty for default based on env/role",
            "Type": "String"
        },
        "DeploymentConfigurationMinimumHealthyPercent": {
            "Default": "",
            "Description": "DeploymentConfiguration MinimumHealthyPercent - empty for default based on env/role",
            "Type": "String"
        },
        "DockerLabelLastUpdate": {
            "Default": "",
            "Description": "Use to force redeploy",
            "Type": "String"
        },
        "Env": {
            "AllowedValues": [
                "dev",
                "stg",
                "prod"
            ],
            "Default": "dev",
            "Description": "Environment",
            "Type": "String"
        },
        "EnvApp1Version": {
            "AllowedPattern": "^[a-zA-Z0-9-_.]*$",
            "Default": "1",
            "Description": "EnvApp1Version",
            "Type": "String"
        },
        "EnvRole": {
            "AllowedPattern": "^[a-zA-Z0-9-_.]*$",
            "Default": "",
            "Description": "Service Role",
            "Type": "String"
        },
        "EnvShort": {
            "AllowedValues": [
                "dev",
                "stg",
                "prd"
            ],
            "Default": "dev",
            "Description": "Environment Short - NEVER CHANGE!",
            "Type": "String"
        },
        "EnvStackVersion": {
            "Default": "1",
            "Description": "Stack version, if changed with UpdateMode=Cfn triggers cfn-hup",
            "Type": "String"
        },
        "LaunchType": {
            "AllowedValues": [
                "",
                "EC2",
                "FARGATE"
            ],
            "Default": "",
            "Description": "RunTask LaunchType - empty for default based on env/role",
            "Type": "String"
        },
        "ListenerLoadBalancerHttpPort": {
            "Default": "",
            "Description": "Http Port where Load Balancer listen - empty for default based on env/role",
            "Type": "String"
        },
        "ListenerLoadBalancerHttpsPort": {
            "Default": "",
            "Description": "Http Port where Load Balancer listen - empty for default based on env/role",
            "Type": "String"
        },
        "LoadBalancerApplicationStack": {
            "Default": "",
            "Description": "LoadBalancer Application Stack to use - empty for default based on env/role",
            "Type": "String"
        },
        "LoadBalancerSslCertificate": {
            "Default": "",
            "Description": "Load Balancer External Ssl Certificate - None to disable - empty for default based on env/role",
            "Type": "String"
        },
        "LogDriver": {
            "AllowedValues": [
                "",
                "None",
                "awslogs",
                "fluentd",
                "gelf",
                "journald",
                "json-file",
                "splunk",
                "syslog"
            ],
            "Default": "",
            "Description": "Log driver for task container - empty for default",
            "Type": "String"
        },
        "Memory": {
            "Default": "",
            "Description": "Memory used by task - empty for default based on env/role",
            "Type": "String"
        },
        "NetworkMode": {
            "AllowedValues": [
                "",
                "awsvpc",
                "bridge"
            ],
            "Default": "",
            "Description": "Task NetworkMode - empty for default based on env/role",
            "Type": "String"
        },
        "SecurityGroups": {
            "AllowedPattern": "^(\\w*,\\w*){3}$",
            "Default": ",,,",
            "Description": "SecurityGroups List Extra - ,,, for default based on env/role",
            "Type": "String"
        }
    },
    "Resources": {
        "IAMPolicyCloudWatch": {
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "cloudwatch:PutMetricData"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "CloudWatch",
                "Roles": [
                    {
                        "Ref": "RoleTask"
                    }
                ]
            },
            "Type": "AWS::IAM::Policy"
        },
        "IAMPolicyParameterStore": {
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": "kms:Decrypt",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::ImportValue": "KeyParameterStore"
                            }
                        },
                        {
                            "Action": "ssm:DescribeParameters",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:*"
                            }
                        },
                        {
                            "Action": "ssm:GetParameters",
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvRole}/*"
                                },
                                {
                                    "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/${EnvRole}/*"
                                }
                            ]
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ParameterStore",
                "Roles": [
                    {
                        "Ref": "RoleTask"
                    }
                ]
            },
            "Type": "AWS::IAM::Policy"
        },
        "LogsLogGroup": {
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/ecs/${AWS::StackName}"
                },
                "RetentionInDays": 30
            },
            "Type": "AWS::Logs::LogGroup"
        },
        "RoleTask": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ecs-tasks.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "Path": "/"
            },
            "Type": "AWS::IAM::Role"
        },
        "SecurityGroupEcsService": {
            "Condition": "NetworkModeAwsVpc",
            "Properties": {
                "GroupDescription": "Enable access to Service",
                "SecurityGroupIngress": [],
                "VpcId": {
                    "Fn::ImportValue": "VpcId"
                }
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "Service": {
            "Properties": {
                "Cluster": {
                    "Fn::ImportValue": {
                        "Fn::Sub": [
                            "Cluster-${ClusterStack}",
                            {
                                "ClusterStack": {
                                    "Fn::If": [
                                        "ClusterStackOverride",
                                        {
                                            "Ref": "ClusterStack"
                                        },
                                        "ecs-a"
                                    ]
                                }
                            }
                        ]
                    }
                },
                "LaunchType": {
                    "Fn::If": [
                        "LaunchTypeOverride",
                        {
                            "Ref": "LaunchType"
                        },
                        "EC2"
                    ]
                },
                "NetworkConfiguration": {
                    "Fn::If": [
                        "NetworkModeAwsVpc",
                        {
                            "AwsvpcConfiguration": {
                                "SecurityGroups": [
                                    {
                                        "Fn::GetAtt": [
                                            "SecurityGroupEcsService",
                                            "GroupId"
                                        ]
                                    },
                                    {
                                        "Fn::If": [
                                            "SecurityGroup0",
                                            {
                                                "Fn::ImportValue": {
                                                    "Fn::Sub": [
                                                        "SecurityGroup${ImportName}",
                                                        {
                                                            "ImportName": {
                                                                "Fn::Select": [
                                                                    0,
                                                                    {
                                                                        "Fn::Split": [
                                                                            ",",
                                                                            {
                                                                                "Fn::If": [
                                                                                    "SecurityGroupsOverride",
                                                                                    {
                                                                                        "Ref": "SecurityGroups"
                                                                                    },
                                                                                    "BaseInstance,None,None,None"
                                                                                ]
                                                                            }
                                                                        ]
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ]
                                                }
                                            },
                                            {
                                                "Ref": "AWS::NoValue"
                                            }
                                        ]
                                    },
                                    {
                                        "Fn::If": [
                                            "SecurityGroup1",
                                            {
                                                "Fn::ImportValue": {
                                                    "Fn::Sub": [
                                                        "SecurityGroup${ImportName}",
                                                        {
                                                            "ImportName": {
                                                                "Fn::Select": [
                                                                    1,
                                                                    {
                                                                        "Fn::Split": [
                                                                            ",",
                                                                            {
                                                                                "Fn::If": [
                                                                                    "SecurityGroupsOverride",
                                                                                    {
                                                                                        "Ref": "SecurityGroups"
                                                                                    },
                                                                                    "BaseInstance,None,None,None"
                                                                                ]
                                                                            }
                                                                        ]
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ]
                                                }
                                            },
                                            {
                                                "Ref": "AWS::NoValue"
                                            }
                                        ]
                                    },
                                    {
                                        "Fn::If": [
                                            "SecurityGroup2",
                                            {
                                                "Fn::ImportValue": {
                                                    "Fn::Sub": [
                                                        "SecurityGroup${ImportName}",
                                                        {
                                                            "ImportName": {
                                                                "Fn::Select": [
                                                                    2,
                                                                    {
                                                                        "Fn::Split": [
                                                                            ",",
                                                                            {
                                                                                "Fn::If": [
                                                                                    "SecurityGroupsOverride",
                                                                                    {
                                                                                        "Ref": "SecurityGroups"
                                                                                    },
                                                                                    "BaseInstance,None,None,None"
                                                                                ]
                                                                            }
                                                                        ]
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ]
                                                }
                                            },
                                            {
                                                "Ref": "AWS::NoValue"
                                            }
                                        ]
                                    },
                                    {
                                        "Fn::If": [
                                            "SecurityGroup3",
                                            {
                                                "Fn::ImportValue": {
                                                    "Fn::Sub": [
                                                        "SecurityGroup${ImportName}",
                                                        {
                                                            "ImportName": {
                                                                "Fn::Select": [
                                                                    3,
                                                                    {
                                                                        "Fn::Split": [
                                                                            ",",
                                                                            {
                                                                                "Fn::If": [
                                                                                    "SecurityGroupsOverride",
                                                                                    {
                                                                                        "Ref": "SecurityGroups"
                                                                                    },
                                                                                    "BaseInstance,None,None,None"
                                                                                ]
                                                                            }
                                                                        ]
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ]
                                                }
                                            },
                                            {
                                                "Ref": "AWS::NoValue"
                                            }
                                        ]
                                    }
                                ],
                                "Subnets": {
                                    "Fn::Split": [
                                        ",",
                                        {
                                            "Fn::ImportValue": "SubnetsPrivate"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "SchedulingStrategy": "DAEMON",
                "TaskDefinition": {
                    "Ref": "TaskDefinition"
                }
            },
            "Type": "AWS::ECS::Service"
        },
        "TaskDefinition": {
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Command": [
                            "tail",
                            "-f",
                            ".dockerenv"
                        ],
                        "Cpu": {
                            "Fn::If": [
                                "CpuTask",
                                {
                                    "Fn::If": [
                                        "CpuOverride",
                                        {
                                            "Ref": "Cpu"
                                        },
                                        "None"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "ContainerDefinitions1CpuOverride",
                                        {
                                            "Ref": "ContainerDefinitions1Cpu"
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                {
                                                    "Ref": "EnvShort"
                                                },
                                                {
                                                    "Ref": "AWS::Region"
                                                },
                                                "ContainerDefinitions1Cpu"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "DockerLabels": {
                            "Fn::If": [
                                "DockerLabelLastUpdateOverride",
                                {
                                    "LastUpdate": {
                                        "Ref": "DockerLabelLastUpdate"
                                    }
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        },
                        "Environment": [
                            {
                                "Name": "EnvRegion",
                                "Value": {
                                    "Ref": "AWS::Region"
                                }
                            },
                            {
                                "Name": "Env",
                                "Value": {
                                    "Ref": "Env"
                                }
                            },
                            {
                                "Name": "EnvAbbr",
                                "Value": {
                                    "Ref": "EnvShort"
                                }
                            },
                            {
                                "Name": "EnvBrand",
                                "Value": "numenor.arda"
                            },
                            {
                                "Name": "EnvRole",
                                "Value": {
                                    "Ref": "EnvRole"
                                }
                            },
                            {
                                "Name": "EnvStackName",
                                "Value": {
                                    "Ref": "AWS::StackName"
                                }
                            },
                            {
                                "Name": "EnvClusterStackName",
                                "Value": {
                                    "Fn::If": [
                                        "ClusterStackOverride",
                                        {
                                            "Ref": "ClusterStack"
                                        },
                                        "ecs-a"
                                    ]
                                }
                            }
                        ],
                        "Essential": "true",
                        "Image": "amazonlinux:2",
                        "LogConfiguration": {
                            "Fn::If": [
                                "LogConfiguration",
                                {
                                    "LogDriver": {
                                        "Fn::If": [
                                            "LogDriverOverride",
                                            {
                                                "Ref": "LogDriver"
                                            },
                                            "awslogs"
                                        ]
                                    },
                                    "Options": {
                                        "awslogs-group": {
                                            "Ref": "LogsLogGroup"
                                        },
                                        "awslogs-region": {
                                            "Ref": "AWS::Region"
                                        },
                                        "awslogs-stream-prefix": {
                                            "Ref": "AWS::StackName"
                                        }
                                    }
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        },
                        "Memory": {
                            "Fn::If": [
                                "LaunchTypeFarGate",
                                {
                                    "Fn::If": [
                                        "MemoryOverride",
                                        {
                                            "Ref": "Memory"
                                        },
                                        512
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "ContainerDefinitions1MemoryOverride",
                                        {
                                            "Ref": "ContainerDefinitions1Memory"
                                        },
                                        64
                                    ]
                                }
                            ]
                        },
                        "MemoryReservation": {
                            "Fn::If": [
                                "ContainerDefinitions1MemoryReservationOverride",
                                {
                                    "Ref": "ContainerDefinitions1MemoryReservation"
                                },
                                32
                            ]
                        },
                        "Name": {
                            "Ref": "EnvRole"
                        }
                    }
                ],
                "Cpu": {
                    "Fn::If": [
                        "CpuTask",
                        {
                            "Fn::If": [
                                "CpuOverride",
                                {
                                    "Ref": "Cpu"
                                },
                                "None"
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "ExecutionRoleArn": {
                    "Fn::If": [
                        "LaunchTypeFarGate",
                        {
                            "Fn::ImportValue": "RoleECSTaskExecution"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Memory": {
                    "Fn::If": [
                        "LaunchTypeFarGate",
                        {
                            "Fn::If": [
                                "MemoryOverride",
                                {
                                    "Ref": "Memory"
                                },
                                512
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "NetworkMode": {
                    "Fn::If": [
                        "NetworkModeAwsVpc",
                        "awsvpc",
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "RequiresCompatibilities": {
                    "Fn::If": [
                        "LaunchTypeFarGate",
                        [
                            "EC2",
                            "FARGATE"
                        ],
                        [
                            "EC2"
                        ]
                    ]
                },
                "TaskRoleArn": {
                    "Ref": "RoleTask"
                }
            },
            "Type": "AWS::ECS::TaskDefinition"
        }
    }
}
